 /*
        两个参数
        file：图片格式的文件，        
        callback：回调函数，返回base64串
        调用方法：ImageCompress(file,callback)；
		依赖插件：exif.js （解决ios拍照上传图片旋转问题）
		只对500kb以上的图片进行压缩
		用法见example.html
        */
;(function(win){function ImageCompress(file,callback){var timestamp=new Date().getTime();var thiz=this,qt=0.5,reader=null,image=null,needCompress=false,type=null;reader=new FileReader();image=new Image();var name=file.name||'WEIMINGM';type=(name.substr(name.lastIndexOf("."))).toLowerCase();if(type!=".jpg"&&type!=".png"&&type!=".jpeg"&&type!=".pdf"){return false;}
var fileSize=file.size;if(fileSize>10*1024){needCompress=true;}
if(/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)){qt=0.5;}else if(/(Android)/i.test(navigator.userAgent)){qt=0.7;}else{qt=0.7;};if(file&&type!=".pdf"&&needCompress){var Orientation=1;EXIF.getData(file,function(){Orientation=EXIF.getTag(this,'Orientation');});reader.readAsDataURL(file);reader.onload=function(ev){image.src=ev.target.result;image.onload=function(){var imgWidth=this.width,imgHeight=this.height;if(this.width>this.height&&this.height>1600){imgHeight=1500;imgWidth=Math.round(this.width*imgHeight/this.height);}
if(this.height>this.width&&this.width>1600){imgWidth=1500;imgHeight=Math.round(imgWidth*this.height/this.width);}
var canvas=document.createElement("canvas"),ctx=canvas.getContext('2d');canvas.width=imgWidth;canvas.height=imgHeight;if(Orientation&&Orientation!=1){switch(Orientation){case 6:canvas.width=imgHeight;canvas.height=imgWidth;ctx.rotate(Math.PI/2);ctx.drawImage(this,0,-imgHeight,imgWidth,imgHeight);break;case 3:ctx.rotate(Math.PI);ctx.drawImage(this,-imgWidth,-imgHeight,imgWidth,imgHeight);break;case 8:canvas.width=imgHeight;canvas.height=imgWidth;ctx.rotate(3*Math.PI/2);ctx.drawImage(this,-imgWidth,0,imgWidth,imgHeight);break;}}else{ctx.drawImage(this,0,0,imgWidth,imgHeight);}
var ndata=canvas.toDataURL("image/jpeg",qt);callback&&callback(ndata);}}}}
win.ImageCompress=ImageCompress;})(window);